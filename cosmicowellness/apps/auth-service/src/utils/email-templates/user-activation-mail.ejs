/**
 * Kosmico User Activation Email Service
 * Complete implementation with EJS template rendering and email sending
 */

const ejs = require('ejs');
const fs = require('fs');
const path = require('path');
const nodemailer = require('nodemailer'); // npm install nodemailer

// ============================================
// EMAIL CONFIGURATION
// ============================================

const emailConfig = {
    from: {
        name: 'Kosmico Team',
        email: 'noreply@kosmico.com'
    },
    smtp: {
        host: process.env.SMTP_HOST || 'smtp.gmail.com',
        port: process.env.SMTP_PORT || 587,
        secure: false, // true for 465, false for other ports
        auth: {
            user: process.env.SMTP_USER || 'your-email@gmail.com',
            pass: process.env.SMTP_PASS || 'your-app-password'
        }
    }
};

// ============================================
// CREATE EMAIL TRANSPORTER
// ============================================

const createTransporter = () => {
    return nodemailer.createTransport(emailConfig.smtp);
};

// ============================================
// RENDER EJS TEMPLATE
// ============================================

const renderEmailTemplate = (templateName, data) => {
    try {
        const templatePath = path.join(__dirname, `${templateName}.ejs`);
        
        if (!fs.existsSync(templatePath)) {
            throw new Error(`Template file not found: ${templatePath}`);
        }
        
        const template = fs.readFileSync(templatePath, 'utf-8');
        const html = ejs.render(template, data);
        
        return html;
    } catch (error) {
        console.error('Error rendering email template:', error);
        throw error;
    }
};

// ============================================
// SEND ACTIVATION EMAIL
// ============================================

const sendActivationEmail = async (userData) => {
    try {
        // Validate required fields
        if (!userData.userEmail) {
            throw new Error('User email is required');
        }
        if (!userData.userName) {
            throw new Error('User name is required');
        }
        if (!userData.activationLink) {
            throw new Error('Activation link is required');
        }

        // Prepare email data with defaults
        const emailData = {
            userName: userData.userName,
            activationLink: userData.activationLink,
            expirationTime: userData.expirationTime || '24 hours',
            supportEmail: userData.supportEmail || 'support@kosmico.com',
            websiteUrl: userData.websiteUrl || 'https://kosmico.com',
            socialLinks: userData.socialLinks || {
                twitter: 'https://twitter.com/kosmico',
                linkedin: 'https://linkedin.com/company/kosmico',
                github: 'https://github.com/kosmico'
            }
        };

        // Render the email template
        console.log('Rendering email template...');
        const html = renderEmailTemplate('user-activation-mail', emailData);

        // Create transporter
        const transporter = createTransporter();

        // Configure email options
        const mailOptions = {
            from: `"${emailConfig.from.name}" <${emailConfig.from.email}>`,
            to: userData.userEmail,
            subject: userData.subject || 'Activate Your Kosmico Account',
            html: html,
            // Plain text version (fallback)
            text: `
Welcome to Kosmico, ${userData.userName}!

Thank you for signing up! Please activate your account by visiting this link:
${userData.activationLink}

This link will expire in ${emailData.expirationTime}.

If you didn't create an account with Kosmico, please ignore this email.

Best regards,
Kosmico Team
            `.trim()
        };

        // Send email
        console.log(`Sending activation email to ${userData.userEmail}...`);
        const info = await transporter.sendMail(mailOptions);

        console.log('âœ… Activation email sent successfully!');
        console.log('Message ID:', info.messageId);
        
        return {
            success: true,
            messageId: info.messageId,
            preview: nodemailer.getTestMessageUrl(info) // Preview URL for testing
        };

    } catch (error) {
        console.error('âŒ Error sending activation email:', error);
        throw error;
    }
};

// ============================================
// GENERATE ACTIVATION TOKEN (HELPER)
// ============================================

const crypto = require('crypto');

const generateActivationToken = (userId) => {
    // Generate a secure random token
    const token = crypto.randomBytes(32).toString('hex');
    
    // In production, you should:
    // 1. Store this token in your database with userId
    // 2. Set an expiration time (e.g., 24 hours)
    // 3. Hash the token before storing
    
    return token;
};

// ============================================
// CREATE ACTIVATION LINK (HELPER)
// ============================================

const createActivationLink = (token, baseUrl = 'https://kosmico.com') => {
    return `${baseUrl}/activate?token=${token}`;
};

// ============================================
// COMPLETE WORKFLOW EXAMPLE
// ============================================

const handleUserRegistration = async (user) => {
    try {
        console.log('ðŸ“§ Processing user registration for:', user.email);
        
        // 1. Generate activation token
        const token = generateActivationToken(user.id);
        console.log('ðŸ” Generated activation token');
        
        // 2. Create activation link
        const activationLink = createActivationLink(token);
        console.log('ðŸ”— Created activation link');
        
        // 3. Send activation email
        const emailData = {
            userEmail: user.email,
            userName: user.name,
            activationLink: activationLink,
            expirationTime: '24 hours',
            supportEmail: 'support@kosmico.com',
            websiteUrl: 'https://kosmico.com',
            socialLinks: {
                twitter: 'https://twitter.com/kosmico',
                linkedin: 'https://linkedin.com/company/kosmico',
                github: 'https://github.com/kosmico'
            }
        };
        
        const result = await sendActivationEmail(emailData);
        
        console.log('âœ¨ User registration process completed!');
        return result;
        
    } catch (error) {
        console.error('Error in user registration workflow:', error);
        throw error;
    }
};

// ============================================
// USAGE EXAMPLES
// ============================================

// Example 1: Simple usage
const example1 = async () => {
    const userData = {
        userEmail: 'john.doe@example.com',
        userName: 'John Doe',
        activationLink: 'https://kosmico.com/activate?token=abc123xyz789',
        expirationTime: '24 hours'
    };
    
    await sendActivationEmail(userData);
};

// Example 2: Complete registration workflow
const example2 = async () => {
    const newUser = {
        id: '12345',
        email: 'jane.smith@example.com',
        name: 'Jane Smith'
    };
    
    await handleUserRegistration(newUser);
};

// Example 3: Batch send to multiple users
const example3 = async () => {
    const users = [
        { email: 'user1@example.com', name: 'User One', id: '1' },
        { email: 'user2@example.com', name: 'User Two', id: '2' },
        { email: 'user3@example.com', name: 'User Three', id: '3' }
    ];
    
    for (const user of users) {
        try {
            await handleUserRegistration(user);
            // Add delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 1000));
        } catch (error) {
            console.error(`Failed to send email to ${user.email}:`, error.message);
        }
    }
};

// ============================================
// RUN EXAMPLE (Uncomment to test)
// ============================================

/*
(async () => {
    try {
        await example1();
        // or
        // await example2();
        // or
        // await example3();
    } catch (error) {
        console.error('Example failed:', error);
    }
})();
*/

// ============================================
// EXPORTS
// ============================================

module.exports = {
    sendActivationEmail,
    renderEmailTemplate,
    generateActivationToken,
    createActivationLink,
    handleUserRegistration
};